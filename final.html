<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Happy 23rd Birthday!</title>
  <style>
    :root{
      --bg:#0b0f1a;--card:#121827;--accent:#ffd166;--accent-2:#ff9f1c;--text:#e6edf7;--muted:#8b9bb0;
      --ok:#3ddc97;--warn:#ff595e;--cake:#8b4513;--frosting:#f8f8ff;--pink:#ffb6c1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1000px 600px at 50% -100px, #142038 0%, var(--bg) 60%);
      color:var(--text); padding:12px; overflow-x:auto;
    }
    .app{width:100%; padding:16px 0; position:relative}
    header{text-align:center; margin-bottom:16px}
    header h1{font-size:clamp(18px, 4vw, 28px); margin:0; letter-spacing:.3px; background: linear-gradient(45deg, var(--accent), var(--pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;}
    header .subtitle{color:var(--muted); font-size:clamp(12px, 2.5vw, 16px); margin-top:4px}

    .cake-container{position:relative; display:grid; place-items:center; padding:20px 20px 40px 20px; min-height:350px; margin-top:-20px}

    /* Cake Base */
    .cake{position:relative; z-index:1; display:flex; flex-direction:column-reverse; align-items:center}
    .cake-layer{border-radius:20px; position:relative}
    .cake-bottom{width:280px; height:90px; background: linear-gradient(180deg, #d2691e, #8b4513); box-shadow: 0 8px 20px rgba(0,0,0,.3)}
    .cake-middle{width:240px; height:75px; background: linear-gradient(180deg, #daa520, #b8860b); box-shadow: 0 6px 15px rgba(0,0,0,.25); margin-bottom:-10px}
    .cake-top{width:200px; height:40px; background: linear-gradient(180deg, var(--frosting), #f0f0f0); box-shadow: 0 4px 12px rgba(0,0,0,.2); margin-bottom:-8px}

    /* Frosting decorations */
    .frosting-swirl{position:absolute; width:15px; height:15px; background:var(--pink); border-radius:50%; box-shadow: 0 0 8px rgba(255,182,193,.5)}
    .swirl-1{top:-5px; left:20px}
    .swirl-2{top:-5px; right:20px}
    .swirl-3{top:-5px; left:50%; transform:translateX(-50%)}

    /* Candle positioning */
    .candles-container{position:absolute; top:120px; left:50%; transform:translateX(-50%); width:200px; display:grid; z-index:10}
    
    /* Top row - 6 candles */
    .candles-top{display:flex; justify-content:space-between; align-items:end; margin-bottom:15px; padding:0 30px}
    
    /* Middle row - 8 candles */
    .candles-middle{display:flex; justify-content:space-between; align-items:end; margin-bottom:15px; padding:0 10px}
    
    /* Bottom row - 9 candles */
    .candles-bottom{display:flex; justify-content:space-between; align-items:end; padding:0 5px}

    /* Individual candle */
    .candle{position:relative; width:12px; height:35px; background:#f0e7da; border-radius:4px; box-shadow: inset 0 -8px 12px rgba(0,0,0,.15);}  
    .wick{position:absolute; top:-8px; left:50%; transform:translateX(-50%); width:2px; height:6px; background:#333; border-radius:2px}

    .flame{position:relative; top:-18px; left:50%; transform:translateX(-50%); width:8px; height:12px; background: radial-gradient(50% 65% at 50% 55%, #fff7b0 0%, #ffd166 35%, #ff9f1c 70%, rgba(255,159,28,.0) 72%);
      border-radius:50% 50% 50% 50%/65% 65% 35% 35%; filter: drop-shadow(0 0 4px #ffcf6e);
      animation: flicker .18s infinite alternate ease-in-out, sway 2.8s infinite ease-in-out;
      transform-origin: 50% 100%; opacity:1; pointer-events:none;
    }
    @keyframes flicker{from{transform:translateX(-50%) scaleY(1)} to{transform:translateX(-50%) scaleY(1.1)}}
    @keyframes sway{0%{transform:translateX(-50%) rotate(-1deg)} 50%{transform:translateX(-50%) rotate(1deg)} 100%{transform:translateX(-50%) rotate(-1deg)}}

    .smoke{position:absolute; top:-25px; left:50%; transform:translateX(-50%); width:4px; height:4px; border-radius:50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0)); opacity:0; pointer-events:none}
    .smoke.on{animation: smoke 2s ease-out forwards}
    @keyframes smoke{
      0%{opacity:.0; transform:translate(-50%,0) scale(.5)}
      15%{opacity:.6}
      100%{opacity:0; transform:translate(-50%,-40px) scale(1.8)}
    }

    /* Controls */
    .controls{display:grid; grid-template-columns: 1fr; gap:10px; margin-top:16px; background:var(--card); border-radius:20px; padding:16px; box-shadow: 0 10px 40px rgba(0,0,0,.35)}
    button{appearance:none; border:none; padding:12px 16px; border-radius:16px; background:linear-gradient(180deg, #1e293b, #0f172a); color:#e6edf7; font-weight:600; letter-spacing:.3px; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.25); width:100%}
    button:active{transform:translateY(1px)}
    button.birthday{background:linear-gradient(180deg, var(--accent-2), var(--accent)); color:#000}
    .small{font-size:11px; color:var(--muted)}
    .row{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px}

    .meter{height:8px; width:100%; border-radius:999px; background:#0e1626; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(255,255,255,.04)}
    .meter > .fill{height:100%; width:2%; background:linear-gradient(90deg, #3b82f6, #06b6d4);}

    .flex{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .pill{padding:4px 8px; border-radius:999px; background:#0e1626; color:var(--muted); font-size:10px}

    .relight{position:absolute; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.65); border-radius:20px; opacity:0; pointer-events:none; transition:opacity .3s; z-index:100}
    .relight.show{opacity:1; pointer-events:auto}
    .relight button{width:auto}
    .relight .message{text-align:center; margin-bottom:20px; font-size:clamp(16px, 3vw, 24px); color:var(--accent)}

    .status-row{display:flex; align-items:center; gap:8px; justify-content:center; margin-bottom:12px}
    .dot{width:8px; height:8px; border-radius:50%; background:var(--warn)}
    .dot.on{background:var(--ok); box-shadow:0 0 8px var(--ok)}

    .welcome-overlay{position:fixed; inset:0; background:rgba(0,0,0,.85); display:grid; place-items:center; z-index:1000; backdrop-filter:blur(10px)}
    .welcome-content{text-align:center; background:var(--card); padding:40px; border-radius:24px; box-shadow: 0 20px 60px rgba(0,0,0,.5)}
    .welcome-title{font-size:clamp(24px, 6vw, 36px); margin:0 0 20px 0; background: linear-gradient(45deg, var(--accent), var(--pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text}
    .welcome-start{appearance:none; border:none; padding:16px 32px; border-radius:20px; background:linear-gradient(180deg, var(--accent-2), var(--accent)); color:#000; font-weight:700; font-size:18px; cursor:pointer; box-shadow:0 10px 30px rgba(255,159,28,.3); transition:transform .2s}
    /* Letter section */
    .letter-section{display:flex; justify-content:center; margin-top:30px; padding:0 20px}
    
    .letter-item{cursor:pointer; transition:transform .2s}
    .letter-item:hover{transform:translateY(-5px)}
    
    .letter{background:none; border:none; padding:0; cursor:pointer}
    .letter-image-item{width:120px; height:120px; background-image: url('letter.png'); background-size:cover; background-position:center; border-radius:12px}
    
    /* Letter overlay */
    .letter-overlay{position:fixed; inset:0; background:rgba(0,0,0,.85); display:grid; place-items:center; z-index:1000; backdrop-filter:blur(10px); opacity:0; pointer-events:none; transition:opacity .3s; padding:20px}
    .letter-overlay.show{opacity:1; pointer-events:auto}
    .letter-content{background:var(--card); padding:30px; border-radius:20px; box-shadow: 0 20px 60px rgba(0,0,0,.5); width:100%; max-width:600px; max-height:90vh; overflow-y:auto; position:relative}
    .letter-image{width:100%; height:auto; border-radius:12px; background:#f0f0f0; min-height:400px; display:grid; place-items:center; color:var(--muted); font-style:italic}
    .close-letter{position:absolute; top:15px; right:20px; background:none; border:none; color:var(--muted); font-size:28px; cursor:pointer; width:auto; height:auto; display:grid; place-items:center; font-weight:300}
    .close-letter:hover{color:var(--text)}

    @media (max-width: 400px) {
      .cake-bottom{width:240px; height:60px}
      .cake-middle{width:200px; height:50px}
      .cake-top{width:160px; height:32px}
      .candles-container{width:160px; top:100px}
      .candle{width:10px; height:28px}
      .candles-top{padding:0 20px; margin-bottom:12px}
      .candles-middle{padding:0 5px; margin-bottom:12px}
      .candles-bottom{padding:0 2px}
      .letter-section{margin-top:20px}
      .letter-image-item{width:100px; height:100px}
      .letter-content{padding:20px; max-width:95vw}
      .letter-image{min-height:300px}
    }
  </style>
</head>
<body>
  <div class="welcome-overlay" id="welcomeOverlay">
    <div class="welcome-content">
      <h1 class="welcome-title">ðŸŽ‚ Happy Birthday, Mori! ðŸŽ‚</h1>
      <button class="welcome-start" id="welcomeStart">Start Birthday Surprise</button>
    </div>
  </div>

  <div class="app">
    <header>
      <h1>ðŸŽ‚ Happy 23rd Birthday! ðŸŽ‚</h1>
      <div class="subtitle">Make a wish and blow out the candles!</div>
    </header>

    <div class="cake-container">
      <!-- Birthday Cake -->
      <div class="cake">
        <div class="cake-layer cake-bottom">
        </div>
        <div class="cake-layer cake-middle"></div>
        <div class="cake-layer cake-top">
          <div class="frosting-swirl swirl-1"></div>
          <div class="frosting-swirl swirl-2"></div>
          <div class="frosting-swirl swirl-3"></div>
        </div>
      </div>

      <!-- 23 Candles arranged in 3 rows -->
      <div class="candles-container">
        <!-- Top row: 6 candles -->
        <div class="candles-top">
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
        </div>
        
        <!-- Middle row: 8 candles -->
        <div class="candles-middle">
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
        </div>
        
        <!-- Bottom row: 9 candles -->
        <div class="candles-bottom">
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
          <div class="candle"><div class="wick"></div><div class="flame"></div><div class="smoke"></div></div>
        </div>
      </div>

      <!-- Overlay for when candles are blown out (hidden) -->
      <div id="overlay" class="relight" style="display:none">
        <div>
          <div class="message">ðŸŽ‰ Happy Birthday! ðŸŽ‰</div>
          <button id="relightBtn" class="birthday">Light the Candles Again</button>
        </div>
      </div>
    </div>

    <!-- Letter Section -->
    <div class="letter-section">
      <div class="letter-item">
        <button class="letter" id="letterBtn">
          <div class="letter-image-item"></div>
        </button>
      </div>
    </div>

    <!-- Letter Overlay -->
    <div class="letter-overlay" id="letterOverlay">
      <div class="letter-content">
        <button class="close-letter" id="closeLetter">Ã—</button>
        <div class="letter-image" id="letterImage">
          <img src="letter_cont.jpg" alt="Letter" class="letter-image">
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="status-row">
        <div id="status" class="dot" title="Microphone status"></div>
        <span id="micLabel" class="small">Microphone: Off</span>
      </div>

      <button id="startBtn">ðŸŽ¤ Enable Microphone to Blow Candles</button>

      <div class="row">
        <div class="meter"><div id="levelFill" class="fill"></div></div>
        <span class="pill" id="levelPill">0</span>
      </div>

      <label class="small" for="sens">Sensitivity (lower = easier to blow out)</label>
      <input id="sens" type="range" min="2" max="20" value="6" />

      <div class="flex small">
        <span>ðŸ’¡ Tip: Blow gently on your phone's microphone. Try adjusting sensitivity if needed.</span>
      </div>
    </div>

    <footer style="display:none">
      Audio processing happens on your device only. No data is sent anywhere.
    </footer>
  </div>

<script>
(function(){
  const welcomeOverlay = document.getElementById('welcomeOverlay');
  const welcomeStart = document.getElementById('welcomeStart');
  const startBtn = document.getElementById('startBtn');
  const relightBtn = document.getElementById('relightBtn');
  const overlay = document.getElementById('overlay');
  const statusDot = document.getElementById('status');
  const levelFill = document.getElementById('levelFill');
  const levelPill = document.getElementById('levelPill');
  const sens = document.getElementById('sens');
  const micLabel = document.getElementById('micLabel');
  
  // Letter elements
  const letterBtn = document.getElementById('letterBtn');
  const letterOverlay = document.getElementById('letterOverlay');
  const closeLetter = document.getElementById('closeLetter');

  // Get all flames and smoke elements
  const flames = document.querySelectorAll('.flame');
  const smokes = document.querySelectorAll('.smoke');

  let audioCtx, analyser, source, micStream;
  let freqBuf, timeBuf;
  let rafId;
  let baselineHF = 0;
  let quenched = false;
  let armed = true;
  const ARM_COOLDOWN_MS = 1000;

  function setMicUI(on){
    statusDot.classList.toggle('on', !!on);
    micLabel.textContent = on ? 'Microphone: On' : 'Microphone: Off';
    startBtn.textContent = on ? 'ðŸŽ¤ Microphone Enabled' : 'ðŸŽ¤ Enable Microphone to Blow Candles';
  }

  function relight(){
    quenched = false;
    
    // Hide all smoke and show all flames
    smokes.forEach(smoke => smoke.classList.remove('on'));
    flames.forEach(flame => flame.style.opacity = 1);
    
    armed = true;
  }

  function blowOut(){
    if(quenched) return;
    quenched = true;
    
    // Hide all flames with staggered timing for a nice effect
    flames.forEach((flame, index) => {
      setTimeout(() => {
        flame.style.opacity = 0;
      }, index * 50); // 50ms delay between each candle
    });
    
    // Show smoke from all candles
    setTimeout(() => {
      smokes.forEach((smoke, index) => {
        setTimeout(() => {
          smoke.classList.remove('on');
          void smoke.offsetWidth; // force reflow
          smoke.classList.add('on');
        }, index * 40);
      });
    }, 200);
    
    armed = false;
    setTimeout(() => armed = true, ARM_COOLDOWN_MS);
  }

  async function initAudio(){
    try{
      // Check if getUserMedia is supported
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('Your browser does not support microphone access. Please use Chrome, Safari, or Firefox.');
      }

      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({latencyHint:'interactive'});
      }
      if(audioCtx.state === 'suspended') await audioCtx.resume();

      // Request microphone with more permissive settings for mobile
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: false,
          noiseSuppression: false,
          autoGainControl: false
        },
        video: false
      });

      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = 0.85;

      source = audioCtx.createMediaStreamSource(micStream);
      source.connect(analyser);

      freqBuf = new Uint8Array(analyser.frequencyBinCount);
      timeBuf = new Uint8Array(analyser.fftSize);

      // Baseline calibration
      baselineHF = 0;
      const CALIB_MS = 400;
      const t0 = performance.now();
      while(performance.now() - t0 < CALIB_MS){
        analyser.getByteFrequencyData(freqBuf);
        baselineHF += hfEnergy(freqBuf);
      }
      baselineHF = baselineHF / Math.max(1, Math.round(CALIB_MS/16));

      animate();
      setMicUI(true);
    }catch(err){
      console.error('Microphone error:', err);
      let errorMsg = 'Microphone access failed. ';
      
      if (err.name === 'NotAllowedError') {
        errorMsg += 'Please allow microphone access in your browser settings and try again.';
      } else if (err.name === 'NotFoundError') {
        errorMsg += 'No microphone found on your device.';
      } else if (err.name === 'NotSupportedError') {
        errorMsg += 'Your browser does not support microphone access.';
      } else {
        errorMsg += 'Please check your microphone permissions and try again.';
      }
      
      alert(errorMsg);
      setMicUI(false);
    }
  }

  function hfEnergy(buf){
    const sr = audioCtx ? audioCtx.sampleRate : 44100;
    const binHz = sr / analyser.fftSize;
    const startHz = 1800;
    const startBin = Math.max(0, Math.floor(startHz / binHz));
    let sum = 0;
    for(let i=startBin; i<buf.length; i++) sum += buf[i];
    return sum / (buf.length - startBin);
  }

  function levelRMS(buf){
    let sum = 0;
    for(let i=0;i<buf.length;i++){
      const v = (buf[i]-128)/128; sum += v*v;
    }
    return Math.sqrt(sum / buf.length);
  }

  function animate(){
    analyser.getByteFrequencyData(freqBuf);
    analyser.getByteTimeDomainData(timeBuf);

    const hf = hfEnergy(freqBuf);
    const rms = levelRMS(timeBuf);

    // UI meter
    const meterPct = Math.min(100, Math.round(rms*220));
    levelFill.style.width = meterPct+"%";
    levelPill.textContent = String(meterPct);

    // Blow detection
    const factor = Number(sens.value);
    const threshold = baselineHF + factor * 2.5;

    if(armed && !quenched && hf > threshold){
      sustained(hf, threshold, 250).then(hit => { 
        if(hit) blowOut(); 
      });
    }

    rafId = requestAnimationFrame(animate);
  }

  function sustained(currentHF, threshold, ms){
    const deadline = performance.now() + ms;
    return new Promise(resolve => {
      function check(){
        if(performance.now() >= deadline) return resolve(true);
        analyser.getByteFrequencyData(freqBuf);
        const hf = hfEnergy(freqBuf);
        if(hf < threshold){ resolve(false); return; }
        requestAnimationFrame(check);
      }
      requestAnimationFrame(check);
    });
  }

  startBtn.addEventListener('click', initAudio);
  relightBtn.addEventListener('click', relight);
  
  // Welcome overlay
  welcomeStart.addEventListener('click', () => {
    welcomeOverlay.style.display = 'none';
  });
  
  // Letter functionality
  letterBtn.addEventListener('click', () => {
    letterOverlay.classList.add('show');
  });
  
  closeLetter.addEventListener('click', () => {
    letterOverlay.classList.remove('show');
  });
  
  // Close letter when clicking outside
  letterOverlay.addEventListener('click', (e) => {
    if (e.target === letterOverlay) {
      letterOverlay.classList.remove('show');
    }
  });

  // Allow tapping the cake to relight
  document.querySelector('.cake-container').addEventListener('click', ()=>{
    if(quenched) relight();
  });

  // Pause audio when page is hidden
  document.addEventListener('visibilitychange', ()=>{
    if(!audioCtx) return;
    if(document.hidden) audioCtx.suspend(); else audioCtx.resume();
  });

  // Clean up
  window.addEventListener('beforeunload', ()=>{
    if(rafId) cancelAnimationFrame(rafId);
    if(micStream){
      micStream.getTracks().forEach(t=>t.stop());
    }
    if(audioCtx) audioCtx.close();
  });
})();
</script>
</body>
</html>
